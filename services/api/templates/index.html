<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdsGen 2.0 - Control Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --error: #ef4444;
            --glass: rgba(30, 41, 59, 0.7);
        }

        * {
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%);
            color: var(--text);
            margin: 0;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 968px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            padding: 2rem;
            border-radius: 24px;
            border: 1px solid var(--border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            height: fit-content;
        }

        h1,
        h2 {
            margin-top: 0;
            margin-bottom: 1.5rem;
            background: linear-gradient(to right, #818cf8, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        h1 {
            font-size: 32px;
            font-weight: 700;
        }

        h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group.full {
            grid-column: span 2;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 14px;
            color: var(--text-muted);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            background: #0f172a;
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text);
            font-size: 15px;
            font-family: inherit;
            outline: none;
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-processing {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .status-failed {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .vacancy-list {
            margin-top: 1rem;
            max-height: 600px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        .vacancy-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vacancy-item:last-child {
            border-bottom: none;
        }

        .vacancy-info h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .vacancy-info p {
            margin: 4px 0 0;
            font-size: 13px;
            color: var(--text-muted);
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 1.5rem;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }

        #statusOutput {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 12px;
            font-size: 14px;
            display: none;
        }

        .output-success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: #34d399;
            display: block !important;
        }

        .output-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #f87171;
            display: block !important;
        }

        .links {
            margin-top: 2rem;
            display: flex;
            justify-content: center;
            gap: 24px;
            font-size: 14px;
        }

        .links a {
            color: var(--text-muted);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .links a:hover {
            color: var(--primary);
        }

        /* Loader Animation */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        button.loading .spinner {
            display: block;
        }

        button.loading .btn-text {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Left Column: Form -->
        <div class="panel">
            <h1>AdsGen 2.0 üöÄ</h1>
            <h2>–†—É—á–Ω–æ–π –∏–º–ø–æ—Ä—Ç –¥–ª—è —Ç–µ—Å—Ç–∞</h2>

            <h1>AdsGen 2.0 üöÄ</h1>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('sheets')">Google Sheets Import</button>
                <button class="tab-btn" onclick="switchTab('manual')">Manual Import</button>
            </div>

            <style>
                .tabs {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 20px;
                }

                .tab-btn {
                    background: transparent;
                    border: 1px solid var(--border);
                    color: var(--text-muted);
                    padding: 8px 16px;
                    border-radius: 8px;
                    cursor: pointer;
                    width: auto;
                }

                .tab-btn.active {
                    background: var(--primary);
                    color: white;
                    border-color: var(--primary);
                }

                .step-section {
                    border: 1px solid var(--border);
                    padding: 15px;
                    border-radius: 12px;
                    margin-bottom: 15px;
                    background: rgba(0, 0, 0, 0.2);
                }

                .mapping-row {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    margin-bottom: 8px;
                }

                .mapping-label {
                    flex: 1;
                    font-size: 14px;
                    color: var(--text-muted);
                }

                .mapping-select {
                    flex: 2;
                }

                .hidden {
                    display: none;
                }
            </style>

            <!-- GOOGLE SHEETS FORM -->
            <div id="sheetsPanel">
                <div class="step-section">
                    <label>1. Google Sheet URL / ID</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="sheetUrl" placeholder="https://docs.google.com/spreadsheets/d/..."
                            value="">
                        <button onclick="loadSheets()" id="loadSheetsBtn" style="width: auto;">Load</button>
                    </div>
                </div>

                <div id="step2" class="step-section hidden">
                    <label>2. Select Sheet</label>
                    <select id="sheetSelect" onchange="loadHeaders()">
                        <option value="">Select a sheet...</option>
                    </select>
                </div>

                <div id="step3" class="step-section hidden">
                    <label>3. Map Columns</label>
                    <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">Match internal fields to
                        your sheet columns.</p>

                    <div id="mappingContainer">
                        <!-- Mapping rows will be injected here -->
                    </div>
                </div>

                <button id="importSheetsBtn" onclick="startSheetImport()" class="hidden">
                    <div class="spinner"></div>
                    <span class="btn-text">üöÄ Start Import</span>
                </button>
            </div>

            <!-- MANUAL FORM -->
            <form id="importForm" class="hidden">
                <div class="form-grid">
                    <div class="form-group full">
                        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å / –ü—Ä–æ—Ñ–µ—Å—Å–∏—è</label>
                        <input type="text" id="position" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–∞—Å—Å–∏—Ä">
                    </div>

                    <div class="form-group">
                        <label>ID –≤–∞–∫–∞–Ω—Å–∏–∏ (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)</label>
                        <input type="text" id="vacancyId" placeholder="M123456">
                    </div>

                    <div class="form-group">
                        <label>–ì–æ—Ä–æ–¥</label>
                        <input type="text" id="city" placeholder="–ú–æ—Å–∫–≤–∞">
                    </div>

                    <div class="form-group full">
                        <label>–ê–¥—Ä–µ—Å</label>
                        <input type="text" id="address" placeholder="—É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 1">
                    </div>

                    <div class="form-group">
                        <label>–ì—Ä–∞—Ñ–∏–∫</label>
                        <select id="schedule">
                            <option value="2/2">2/2</option>
                            <option value="5/2">5/2</option>
                            <option value="–°–º–µ–Ω–Ω—ã–π">–°–º–µ–Ω–Ω—ã–π</option>
                            <option value="–ì–∏–±–∫–∏–π">–ì–∏–±–∫–∏–π</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–£—Ä–æ–≤–µ–Ω—å</label>
                        <select id="level">
                            <option value="–ë–µ–∑ –æ–ø—ã—Ç–∞">–ë–µ–∑ –æ–ø—ã—Ç–∞</option>
                            <option value="–ù–∞—á–∏–Ω–∞—é—â–∏–π">–ù–∞—á–∏–Ω–∞—é—â–∏–π</option>
                            <option value="–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç">–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–ó–∞—Ä–ø–ª–∞—Ç–∞ –û–¢</label>
                        <input type="number" id="salaryMin" placeholder="45000">
                    </div>

                    <div class="form-group">
                        <label>–ó–∞—Ä–ø–ª–∞—Ç–∞ –î–û</label>
                        <input type="number" id="salaryMax" placeholder="60000">
                    </div>

                    <div class="form-group full">
                        <label>–î–æ–ø. –ø—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                        <textarea id="notes" rows="3" placeholder="–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏..."></textarea>
                    </div>
                </div>

                <button type="submit" id="submitBtn">
                    <div class="spinner"></div>
                    <span class="btn-text">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç</span>
                </button>
            </form>

            <div id="statusOutput"></div>

            <div class="quick-actions">
                <button class="btn-secondary" onclick="startBatch()">
                    <span>üì¶ Batch Process All</span>
                </button>
                <button class="btn-secondary" onclick="exportXml()">
                    <span>üìÑ Export XML</span>
                </button>
            </div>
        </div>

        <!-- Right Column: Recent Vacancies -->
        <div class="panel">
            <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏</h2>
            <div class="vacancy-list" id="vacancyList">
                <p style="text-align: center; color: var(--text-muted); padding: 2rem;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>

            <div class="links">
                <a href="/docs" target="_blank">üìö API Docs</a>
                <a href="http://localhost:5555" target="_blank">üìä Monitor</a>
                <a href="javascript:refreshVacancies()" style="margin-left: auto;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</a>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '';
        let currentHeaders = [];

        const NEEDED_FIELDS = [
            { key: 'city', label: '–ì–æ—Ä–æ–¥ (City)', required: true },
            { key: 'position', label: '–î–æ–ª–∂–Ω–æ—Å—Ç—å (Position)', required: true },
            { key: 'address', label: '–ê–¥—Ä–µ—Å (Address)' },
            { key: 'tk', label: '–¢–ö (Store ID)' },
            { key: 'store_type', label: '–¢–∏–ø –¢–ö (Store Type)' },
            { key: 'schedule', label: '–ì—Ä–∞—Ñ–∏–∫ (Schedule)' },
            { key: 'level', label: '–£—Ä–æ–≤–µ–Ω—å (Level)' },
            { key: 'service', label: '–£—Å–ª—É–≥–∞ (Service)' },
            { key: 'notes', label: '–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ (Notes)' },
            { key: 'relevance', label: '–ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å (Relevance)' }
        ];

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            if (tab === 'sheets') {
                document.querySelector('button[onclick="switchTab(\'sheets\')"]').classList.add('active');
                document.getElementById('sheetsPanel').classList.remove('hidden');
                document.getElementById('importForm').classList.add('hidden');
            } else {
                document.querySelector('button[onclick="switchTab(\'manual\')"]').classList.add('active');
                document.getElementById('sheetsPanel').classList.add('hidden');
                document.getElementById('importForm').classList.remove('hidden');
            }
        }

        async function loadSheets() {
            const url = document.getElementById('sheetUrl').value.trim();
            const btn = document.getElementById('loadSheetsBtn');
            if (!url) return alert('Enter URL');

            btn.innerText = '...';
            try {
                const res = await fetch('/google/sheets/meta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();
                if (res.ok) {
                    const select = document.getElementById('sheetSelect');
                    select.innerHTML = '<option value="">Select a sheet...</option>';
                    data.sheets.forEach(s => {
                        select.innerHTML += `<option value="${s}">${s}</option>`;
                    });
                    document.getElementById('step2').classList.remove('hidden');
                } else {
                    alert('Error: ' + data.detail);
                }
            } catch (e) {
                alert(e.message);
            } finally {
                btn.innerText = 'Load';
            }
        }

        async function loadHeaders() {
            const url = document.getElementById('sheetUrl').value.trim();
            const sheet = document.getElementById('sheetSelect').value;
            if (!sheet) return;

            try {
                const res = await fetch('/google/sheets/headers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, sheet_name: sheet })
                });
                const data = await res.json();
                if (res.ok) {
                    currentHeaders = data.headers;
                    renderMapping();
                    document.getElementById('step3').classList.remove('hidden');
                    document.getElementById('importSheetsBtn').classList.remove('hidden');
                } else {
                    alert('Error: ' + data.detail);
                }
            } catch (e) {
                alert(e.message);
            }
        }

        function renderMapping() {
            const container = document.getElementById('mappingContainer');
            container.innerHTML = '';

            NEEDED_FIELDS.forEach(field => {
                // Try to auto-match
                const headerLower = currentHeaders.map(h => String(h).toLowerCase().trim());
                let selectedIdx = -1;

                // Simple heuristics for auto-select
                const matchers = [field.key, field.label.split('(')[0].trim().toLowerCase()];
                if (field.key === 'city') matchers.push('–≥–æ—Ä–æ–¥');
                if (field.key === 'position') matchers.push('–¥–æ–ª–∂–Ω–æ—Å—Ç—å', '–ø—Ä–æ—Ñ–µ—Å—Å–∏—è');

                for (let m of matchers) {
                    const idx = headerLower.indexOf(m.toLowerCase());
                    if (idx !== -1) {
                        selectedIdx = idx;
                        break;
                    }
                }

                let options = `<option value="">-- Skip --</option>`;
                currentHeaders.forEach(h => {
                    const isSel = (h === currentHeaders[selectedIdx]) ? 'selected' : '';
                    options += `<option value="${h}" ${isSel}>${h}</option>`;
                });

                container.innerHTML += `
                    <div class="mapping-row">
                        <div class="mapping-label">
                            ${field.label} ${field.required ? '<span style="color:var(--error)">*</span>' : ''}
                        </div>
                        <select class="mapping-select" id="map_${field.key}">
                            ${options}
                        </select>
                    </div>
                `;
            });
        }

        async function startSheetImport() {
            const url = document.getElementById('sheetUrl').value.trim();
            const sheet = document.getElementById('sheetSelect').value;
            const btn = document.getElementById('importSheetsBtn');
            const output = document.getElementById('statusOutput');

            // Build mapping
            const mapping = {};
            let missingRequired = false;

            NEEDED_FIELDS.forEach(field => {
                const val = document.getElementById(`map_${field.key}`).value;
                if (val) {
                    mapping[val] = field.key; // { "Column Name": "internal_key" }
                } else if (field.required) {
                    missingRequired = true;
                }
            });

            if (missingRequired) {
                alert('Please map all required fields (*)');
                return;
            }

            btn.classList.add('loading');
            btn.disabled = true;
            output.className = '';
            output.innerText = '';

            try {
                const res = await fetch('/import/sheets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        spreadsheet_input: url,
                        sheet_name: sheet,
                        column_mapping: mapping
                    })
                });
                const result = await res.json();

                if (res.ok) {
                    output.className = 'output-success';
                    output.innerHTML = `‚úÖ <b>Success!</b> Task ID: <br><small>${result.task_id}</small>`;
                    refreshVacancies();
                } else {
                    output.className = 'output-error';
                    output.innerText = `‚ùå Error: ${result.detail || JSON.stringify(result)}`;
                }
            } catch (e) {
                output.className = 'output-error';
                output.innerText = `‚ùå Error: ${e.message}`;
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        }

        // Generate a random ID on load
        document.getElementById('vacancyId').value = 'M' + Math.floor(Math.random() * 900000 + 100000);

        async function refreshVacancies() {
            const list = document.getElementById('vacancyList');
            try {
                const response = await fetch(`${API_URL}/vacancies?per_page=15`);
                const data = await response.json();

                if (data.items.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 2rem;">–í–∞–∫–∞–Ω—Å–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                    return;
                }

                list.innerHTML = data.items.map(v => `
                    <div class="vacancy-item">
                        <div class="vacancy-info">
                            <h3>${v.position}</h3>
                            <p>${v.city} ¬∑ ${v.id}</p>
                            <p style="font-size: 11px;">${new Date(v.created_at).toLocaleString('ru-RU')}</p>
                        </div>
                        <div class="status-badge status-${v.status}">${v.status}</div>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = `<p style="text-align: center; color: var(--error); padding: 2rem;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}</p>`;
            }
        }

        document.getElementById('importForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const output = document.getElementById('statusOutput');

            btn.classList.add('loading');
            btn.disabled = true;
            output.className = '';
            output.innerText = '';

            const data = [{
                id: document.getElementById('vacancyId').value,
                city: document.getElementById('city').value,
                address: document.getElementById('address').value,
                position: document.getElementById('position').value,
                profession: document.getElementById('position').value,
                schedule: document.getElementById('schedule').value,
                level: document.getElementById('level').value,
                salary_min: parseInt(document.getElementById('salaryMin').value) || null,
                salary_max: parseInt(document.getElementById('salaryMax').value) || null,
                notes: document.getElementById('notes').value
            }];

            try {
                const response = await fetch(`${API_URL}/import/json`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (response.ok) {
                    output.className = 'output-success';
                    output.innerHTML = `‚úÖ <b>–£—Å–ø–µ—Ö!</b> –ó–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞: <br><small>${result.task_id}</small>`;

                    // Reset ID
                    document.getElementById('vacancyId').value = 'M' + Math.floor(Math.random() * 900000 + 100000);
                    refreshVacancies();
                } else {
                    console.error('Import Error Details:', result);
                    output.className = 'output-error';
                    const errorMsg = typeof result.detail === 'string'
                        ? result.detail
                        : JSON.stringify(result.detail, null, 2);
                    output.innerText = `‚ùå –û—à–∏–±–∫–∞: ${errorMsg}`;
                }
            } catch (err) {
                output.className = 'output-error';
                output.innerText = `‚ùå –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ${err.message}`;
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
            }
        };

        async function startBatch() {
            if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤—Å–µ—Ö –æ–∂–∏–¥–∞—é—â–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π?')) return;
            try {
                const response = await fetch(`${API_URL}/generate/batch`, { method: 'POST' });
                const result = await response.json();
                alert(`–ó–∞–¥–∞—á–∞ –∑–∞–ø—É—â–µ–Ω–∞: ${result.task_id}`);
            } catch (e) {
                alert(`–û—à–∏–±–∫–∞: ${e.message}`);
            }
        }

        async function exportXml() {
            try {
                const response = await fetch(`${API_URL}/publish/xml`, { method: 'POST' });
                const result = await response.json();
                alert(`–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–ø—É—â–µ–Ω: ${result.task_id}`);
            } catch (e) {
                alert(`–û—à–∏–±–∫–∞: ${e.message}`);
            }
        }

        // Initial load
        refreshVacancies();
        // Auto refresh every 30s
        setInterval(refreshVacancies, 30000);
    </script>
</body>

</html>